<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<input type="text", id="searchtext"></input>
		<button id="search"> Search </button>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script>
		//Här ligger en "eventlistener" som är kopplad till sök-knappen med id:t "search".
		//När knappen trycks in kör funktionen som heter "runProgram".
		document.getElementById("search").addEventListener("click", runProgram);
		document.getElementById("search").addEventListener("click", runProgram);

		var article = {
			title: "",
			id: -1,
			links: [],
			backlinks: [],
			first_paragraph: "",
			position: [null,null],
			time: [null, null]
		}

		var all_articles = [];
		var save;


		//Funktionen som körs när man trycker på "search"
		function runProgram() {		

			var usertext = document.getElementById("searchtext").value;
			var query = getSearchString(usertext);
			//Denna funktion körs asynkront.
			searchWiki(query);
			//Det betyder att HÄR, efter funktionen skulle man kunna ha någon slags loadingscreen, som visas medans vi väntar på ett svar från funktionen.
		}

		//Funktionen kollar att söksträngen inte är tom, byter ut mellanslag
		//mot "%20" (för att wikipedia vill det) och lägger sedan in den i en hårdkodad query.
		//Till sist skickas den färdiga query:n till funktionen "searchWiki".

		function getSearchString(input_title) {
			if(input_title) {
				input_title = input_title.replace(" ", "%20");

				//The beginning of the query, tells us to do a query and return the result on json format.
				var start = "/w/api.php?action=query&format=json";
				//The what to search for
				var title = "&titles=" + input_title;
				//Wich properties to get. (coordinates, links, revisions, extracts, pageid)
				var properties = "&prop=coordinates%7Clinks%7Crevisions%7Cextracts" + "&indexpageids=1" + "&pllimit=max"; 
				var revisions = "&rvprop=content" + "&exintro=1" + "&explaintext=1";
				//Wich lists to get.
				var lists = "&list=backlinks"
				var list_parameters = "&bllimit=max" + "&bltitle=" + input_title;
				//Create final query
				var finalQuery = "http://sv.wikipedia.org" + start + title + properties + revisions + lists + list_parameters + "&callback=?";
			    return finalQuery;
			}
		}
		
		//Funktionen tar en färdig query som input, kör en GET vad nu det innebär, får ett json-objekt som svar, lagrad i variabeln
		//"data".
		function searchWiki(query){
			$(document).ready(function(){
			    $.ajax({
			        type: "GET",
			        url: query,
			        contentType: "application/json; charset=utf-8",
			        async: true,
			        dataType: "json",
			        success: function (data, textStatus, jqXHR) {
			        	console.log(data);
			        	//Här bestäms vad som ska göras med resultatet.
			        	printArticle(load(data));
			        },
			        error: function (errorMessage) {
			        	console.log("Något gick fel.");
			        }
			    });
			});
		}


		function printArticle(article) {
			document.getElementById("resultat").innerHTML = "<b>Artikeltitel:</b> " + article.title
			+ "<br><b>Artikel-Id: </b>" + article.id +"<br><br><b>Första paragrafen i artikeln: </b><br>" + article.first_paragraph + "<br><br>";
			
			//Kolla om det finns en position förknippad med artikeln eller inte.
			if(article.position[0]) {
				document.getElementById("resultat").innerHTML +=  "<b>Artikelns koordinater: </b>" + article.position + "<br><br>";
			}

			document.getElementById("resultat").innerHTML +=  "<b>Länkar i artikeln:</b> ("
			+ article.links.length + " st)<br>";
			for(var indx = 0; indx < article.links.length; indx++) {
				document.getElementById("resultat").innerHTML += article.links[indx];
				document.getElementById("resultat").innerHTML += ", ";
			}

			document.getElementById("resultat").innerHTML +=  "<br><br><b>Artiklar som länkar till denna artikel:</b> ("
			+ article.backlinks.length + " st)<br>";
			for(var indx = 0; indx < article.backlinks.length; indx++) {
				document.getElementById("resultat").innerHTML += article.backlinks[indx];
				document.getElementById("resultat").innerHTML += ", ";
			}
		}

		function load(data) {

			for(var indx = 0; indx < data.query.backlinks.length; indx++) {
				article.backlinks.push(data.query.backlinks[indx].title);
			}
			article.id = data.query.pageids[0];
			article.title = data.query.pages[article.id].title;
			article.first_paragraph = data.query.pages[article.id].extract;

			for(var indx = 0; indx < data.query.pages[article.id].links.length; indx++) {
				article.links.push(data.query.pages[article.id].links[indx].title);
			}
			all_articles.push(article);

			if(data.query.pages[article.id].coordinates) {
				article.position =
					[data.query.pages[article.id].coordinates[0].lat,
					 data.query.pages[article.id].coordinates[0].lon]
			} else {
				article.position = [null,null];
			}
			return article;
		}




	</script>
	</head>
	<body>

	<p id="resultat"></p>

	</body>
</html>